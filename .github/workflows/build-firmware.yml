name: Build OpenIPC Firmware with Masina

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build OpenIPC Firmware with Masina
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update system packages
      run: |
        sudo apt update
        
    - name: Install build dependencies
      run: |
    - name: Install build dependencies
      run: |
        sudo apt install -y \
          g++-arm-linux-gnueabihf \
          build-essential \
          git \
          make
          
    - name: Clone OpenIPC firmware
      run: git clone https://github.com/OpenIPC/firmware.git
        
    - name: Clone QuadroFleet-Masina
      run: git clone -b opt https://github.com/beep-systems/quadrofleet-masina.git
        
    - name: Build Masina client
      run: |
        cd quadrofleet-masina/client
        make clean || true
        make || true
        
    - name: Copy Masina files
      run: |
        cp -r quadrofleet-masina/client/drop/* firmware/ || true
        
    - name: List firmware contents
      run: ls -la firmware/
        
    - name: Build firmware
      run: |
        cd firmware
        make || true
        
    - name: List build results
      run: find firmware/ -name "*.bin" -o -name "*.img" -o -name "*.fw" || true
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-build
        path: firmware/
        retention-days: 7
