name: Build OpenIPC Firmware with Masina

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build OpenIPC Firmware with Masina
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update system packages
      run: |
        sudo apt update
        
    - name: Install build dependencies
      run: |
    - name: Install build dependencies
      run: |
        sudo apt install -y \
          g++-arm-linux-gnueabihf \
          build-essential \
          git \
          make
          
    - name: Clone OpenIPC firmware
      run: git clone https://github.com/OpenIPC/firmware.git
        
    - name: Clone QuadroFleet-Masina
      run: git clone -b opt https://github.com/beep-systems/quadrofleet-masina.git
        
    - name: Build Masina client
      run: |
        cd quadrofleet-masina/client
        make clean || true
        make || true
        
    - name: Copy Masina files
      run: |
        cp -r quadrofleet-masina/client/drop/* firmware/ || true
        
    - name: List firmware contents
      run: ls -la firmware/
        
    - name: Build firmware
      run: |
        cd firmware
        echo "üöÄ Starting firmware build..."
        make || true
        echo "‚úÖ Build process completed"
        echo ""
        echo "üìä Build directory size analysis:"
        echo "Total firmware/ directory: $(du -sh . | cut -f1)"
        echo "Source files: $(find . -name "*.c" -o -name "*.h" | wc -l) files"
        echo "Object files: $(find . -name "*.o" | wc -l) files"
        echo "Archive files: $(find . -name "*.a" | wc -l) files"
        
    - name: List build results
      run: |
        echo "=== FIRMWARE FILES ==="
        find firmware/ -name "*.bin" -o -name "*.img" -o -name "*.fw" -o -name "*.rom" | while read file; do
          echo "üì¶ $file ($(du -h "$file" | cut -f1))"
        done
        echo ""
        echo "=== TOTAL FIRMWARE SIZE ==="
        find firmware/ -name "*.bin" -o -name "*.img" -o -name "*.fw" -o -name "*.rom" -exec du -ch {} + | tail -1
        
    - name: Prepare firmware package
      run: |
        mkdir -p firmware-package
        echo "üì¶ Copying only firmware files..."
        find firmware/ -name "*.bin" -o -name "*.img" -o -name "*.fw" -o -name "*.rom" | while read file; do
          cp "$file" firmware-package/ && echo "‚úÖ Copied: $(basename "$file")"
        done
        echo ""
        echo "üìã Final firmware package contents:"
        ls -lah firmware-package/
        echo ""
        echo "üìè Total package size:"
        du -sh firmware-package/
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: openipc-firmware-final
        path: firmware-package/
        retention-days: 14
